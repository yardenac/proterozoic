#!/bin/bash
# Meant to be run DIRECTLY from a fresh archiso live cd. Try typing, for example:
# [root@archiso]$ dhcpcd eth0
# [root@archiso]$ . <(wget https://raw.github.com/twomen/proterozoic/master/bootstrap-this -qO -)

# Then you probably want to run this:
# root 123m~$ aif -p enzymes/polymerase -d
echo bootstrapping for the 2011.06.10 live cd...

this_pacman() {
	 pacman --config /tmp/pacman.conf.ppz --noprogressbar --noconfirm "$@"
}
# necessary because of the aufs/kernel drama going on. Hopefully it can be temporary...
install_from_schlunix() {
	 for P; do
#		  local package=${P##*/}
#		  local repo=${P%%/*} # -q
		  wget http://schlunix.org/archlinux/extra/os/$arch/$P-$arch.pkg.tar.xz    -O /tmp/$P-$arch.pkg.tar.xz \
				|| {
				echo FAILED TO DOWNLOAD
				exit
		  }
		  echo /tmp/$P-$arch.pkg.tar.xz
	 done | this_pacman -U -
}
arch=$(uname -m)
GITURL=https://raw.github.com/twomen/proterozoic/master

mv -f /etc/rc.conf{,.original}
mv -f /etc/sudoers{,.archiso-default}
wget $GITURL/etc/rc.conf.ppz						-qO	/etc/rc.conf
wget $GITURL/etc/rc.conf.basics					-qO	/etc/rc.conf.basics.tmp
wget $GITURL/etc/pacman.d/mirrorlist.otown	-qO	/etc/pacman.d/mirrorlist.otown.tmp
wget $GITURL/etc/pacman.conf.bootstrap			-qO	/tmp/pacman.conf.ppz
sed -i s/otown/otown.tmp/ig								/tmp/pacman.conf.ppz
sed -i \
	 -e s/rc.conf.basics/rc.conf.basics.tmp/ig \
	 -e s/%SET_HOSTNAME%/archiso/ig \
	 -e 's/^SSH_USERS.*$/SSH_USERS=(root)/ig'			/etc/rc.conf

this_pacman -Sqy
install_from_schlunix	git-1.7.5.2-1 python2-2.7.2-1 screen-4.0.3-11 sshfs-2.2-3
this_pacman -Sq			proterozoic smartmontools

sed -i s/rc.conf.basics.tmp/rc.conf.basics/ig		/etc/rc.conf
rm /tmp/pacman.conf.ppz /etc/pacman.d/mirrorlist.otown.tmp /etc/rc.conf.basics.tmp

add_hook() {:;}
. /etc/rc.conf
. /etc/rc.d/functions.d/ppz
custom_iptables_rules
