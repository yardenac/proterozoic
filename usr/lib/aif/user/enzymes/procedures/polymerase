#!/usr/bin/false
exit

mkdir -p /mnt/etc/pacman.d
sed -e 's/^IgnorePkg[ =]*/\0 linux-linode /ig' \
    -e s/https-only/https-only.random/ig \
    /usr/share/ppz/default/pacman.conf | \
    sudo tee /mnt/etc/pacman.conf
sudo cp /etc/pacman.d/mirrorlist.https-only.random /mnt/etc/pacman.d/

sudo pacstrap -C /mnt/etc/pacman.conf /mnt pacman
# symlink to new pkgcache if desired:
#   mv -i /mnt/var/cache/pacman/pkg/* /mnt/$pkgcache/
#   rm -rf /mnt/var/cache/pacman/pkg
#   ln -s  ../../../$pkgcache /mnt/var/cache/pacman/pkg
sudo pacstrap -C /mnt/etc/pacman.conf /mnt base grub --needed
sudo bash -c 'echo $hostname > /mnt/etc/hostname'
sudo cp /etc/ppz.conf /mnt/etc/ppz.conf
sudo ln -s /usr/share/zoneinfo/America/Los_Angeles /mnt/etc/localtime
sudo mv -i /target/etc/mkinitcpio.conf{,.orig}
sudo cp /etc/mkinitcpio.conf.ppz /mnt/etc/mkinitcpio.conf # add modules: radeon nvidia intel_agp i915
genfstab -U -p /mnt | sudo tee -a /mnt/etc/fstab

# for flashing bios - remember to undo afterwards!
curl -o biosimg.exe $url
sudo biosdisk mkimage -i /mnt/boot/flashbios.img biosimg.exe
sudo cp /usr/lib/syslinux/bios/memdisk /mnt/boot/
sudo tee -a /mnt/etc/grub.d/40_custom <<EOF
   menuentry "Flash BIOS" {
      linux16 /memdisk
      initrd16 /flashbios.img
   }
EOF

sudo arch-chroot /mnt
	pacman -Syu "${pkgs[@]}"
	pacman -Syu proterozoic
	mkinitcpio -p linux
	grub-install --target=i386-pc --recheck --debug /dev/sda
	grub-mkconfig -o /boot/grub/grub.cfg
#  networking

sudo umount -R /mnt
sudo systemctl --no-block poweroff && exec screen -D

pkgs_always=(tor privoxy proterozoic)
pkgs_x=(xorg-{server,xinit,xrdb,xsetroot,xhost,xwininfo,xrandr,xinput} xdotool \
        xf86-input-{keyboard,mouse} xscreensaver xclip libxft xcursor-themes \
        numlockx fvwm perl-xml-parser fbpanel wmctrl mingetty hsetroot \
        urxvt-url-select transset-df xcompmgr acpi ttf-code2000 ttf-code2001 ttf-symbola
        xf86-video-ati xf86-video-intel nvidia mtpfs xcalib redshift \
        urxvt-tabbedex-git urxvt-font-size-git)
pkgs_web=(alsa-utils chromium wget)
pkgs_cd=(cdrkit dvd+rw-tools handbrake-cli libisoburn squashfs-tools archiso-git)
pkgs_wireless=(wireless_tools wpa_supplicant b43-firmware iw) #wpa_actiond ifplugd
pkgs_laptop=(dhcpcd)
pkgs_printer=(cups hplip a2ps)
pkgs_testing=(memtest86+ mprime)
pkgs_other=(parted dmidecode base-devel amd-ucode intel-ucode)
pkgs_dev=(s3cmd cower)
pkgs_more=(pkgfile openbsd-netcat tig)
