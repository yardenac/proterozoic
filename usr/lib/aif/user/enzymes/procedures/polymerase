#!/usr/bin/bash
# cp /{,mnt/}etc/ppz.conf; pacstrap /mnt base proterozoic
# things basically done by aif:
#  import ppz.conf
# this it did
#  set fstab [unnecessary w/systemd?]
#  set hostname
#  set timezone
# never done:
#   /boot/grub/menu.lst
#   /etc/resolv.conf
#   /etc/profile.d/proxy.sh

TARGET=/media/targay

pacman_target() {
	 # --config /usr/share/ppz/default/pacman.conf
	 until /usr/bin/pacman --root ${TARGET} \
		  --cachedir ${TARGET}/var/cache/pacman/pkg \
		  --dbpath ${TARGET}/var/lib/pacman \
		  --logfile ${TARGET}/var/log/pacman.log \
		  --noprogressbar --noconfirm --needed "$@"; do
		  askyn "Pacman did not succeed - try again?" || {
				askyn "Abort?" \
					 && exit \
					 || break
		  }
	 done
}

start_process() {
	 # THIS SECTION SHOULD NOT USE RC.CONF!
	 [ -a ${TARGET}/etc/rc.conf ] \
		  && askyn "Base system already looks populated ... skip reinstalling that?" \
		  || pacman_target -Syq initscripts
	 grep -iq oxygen ${TARGET}/etc/fstab &>/dev/null \
		  && askyn "Looks like we already did some basic configging ... skip that?" || {
		  set +o noclobber
		  cp -f /usr/share/ppz/default/rc.conf ${TARGET}/etc/rc.conf
		  usetvar HOSTTYPE "Choose a host type! [ desktop | laptop | linode ]: " desktop
		  sed -i s/%SET_TYPE%/${HOSTTYPE}/ig ${TARGET}/etc/rc.conf
		  set -o noclobber
	 }
	 [ -a ${TARGET}/usr/bin/Xorg ] && askyn "System looks FULLY installed! Spare the poor mirrors a repeat?" || {
		  pkgs_groups=(x web multimedia cd wireless laptop neverneed)
		  pkgs_x=(xorg-{server,xinit,xrdb,xsetroot,xhost,xwininfo,xrandr} xdotool \
				xf86-input-{keyboard,mouse} xscreensaver xclip libxft xcursor-themes \
				numlockx fvwm perl-xml-parser fbpanel wmctrl mingetty hsetroot \
				urxvt-url-select urxvt-tabbedex transset-df xcompmgr acpi ttf-code2000
				xf86-video-ati xf86-video-intel nvidia mtpfs memtest86+ mprime mtester)
		  pkgs_web=(seamonkey flashplugin alsa-utils openjdk6 icedtea-web sext acroread \
				chromium gecko-mediaplayer)
		  pkgs_multimedia=(gimp feh mpv mencoder imagemagick gcolor2 \
				handbrake-cli mencoder midentify mjpegtools dvdauthor)
		  pkgs_gaming=(zsnes mupen64plus)
		  pkgs_cd=(eject cdrkit dvd+rw-tools handbrake-cli \
				libisoburn squashfs-tools archiso-git)
		  pkgs_wireless=(wireless_tools wpa_supplicant b43-firmware iw) #wpa_actiond ifplugd
		  pkgs_laptop=(pcmciautils dhcpcd)
		  pkgs_printer=(cups hplip a2ps)
		  pkgs_server=(mysql php php-apache php-ssh apache mod_wsgi2 django \
				python-south python2-imaging php-gd)
		  pkgs_neverneed=(licenses logrotate lvm2 nano ppp reiserfsprogs xfsprogs)
		  pkgs_go=($(comm -23 <(pacman -Sgq base | sort -u) \
				<(eval eval list_sorted '\$\{pkgs_'$(commalist ${pkgs_groups[@]})'[@]\}') ))
		  local A=; for A in ${pkgs_groups[@]}; do
				eval askyn 'Install $A things? \(${pkgs_'$A'[@]}\)' && eval 'pkgs_go+=(${pkgs_'$A'[@]})'
		  done
		  pkgs_go+=(btrfs-progs-unstable tor privoxy proterozoic) # grub2-bios
		  usetvar others "Type in any other packages you want to add: " 'aif parted dmidecode base-devel amd-ucode intel-ucode' ''
		  pkgs_go+=(${others//,/ })
		  pacman_target -Sq ${pkgs_go[@]}
		  cp -f ${TARGET}/{usr/share/ppz/default,etc}/pacman.conf
	 }
	 askyn "Use present net config as static on target?" && {
		  static_networking_from_runtime ${TARGET}
	 }
	 askyn "Set root password now?" && {
		  while true; do
				chroot ${TARGET} passwd root && break
		  done
	 }
	 fix_initcpio_ppz ${TARGET}
	 askyn "Install grub? (un/freeze XFS if you have to...)" && {
		  install_grub_ppz ${TARGET} $(unhash targmntboot) $(unhash targmnt) ${HOSTNAME}
		  echo_red "Grub finished."
	 }
}
