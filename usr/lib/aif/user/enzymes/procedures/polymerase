#!/bin/bash
depend_procedure core base
[ -f /etc/bash.functions ] && . /etc/bash.functions

TARGET=/media/targay
MNTPTS=( /boot ) # / is implied

unmount_all() {
	 local RV=0
	 for MNTD_FS in /proc /sys /dev ${MNTPTS[@]} /; do
		  local FULLPATH=${TARGET}${MNTD_FS}
		  grep -iq ${FULLPATH//\/} /etc/mtab \
				&& {
				umount ${FULLPATH//\/} || RV=1
		  }
	 done
	 return $RV
}

start_process() {
	 pushtrap 'poptrap; unmount_all; exit $?;' HUP QUIT EXIT INT ABRT TERM
	 #execute worker configure #just does i/o stuff i dont use
	 execute worker sysprep #remounts / rw
	 usetvar TARGET 'Choose a temporary mount point: '
	 unmount_all || {
		  mount
		  until askyn "Unmounting all failed. You'll have to deal with that first. Whenever you're ready... :)"; do :; done
	 }
	 echo_red "YOU SHOULD HAVE ALREADY PARTITIONED - A LIST TO HELP YOU ;)"
	 blkid | grep -ivE 'raid|crypto_LUKS|squashfs' | sort -u
	 rm -f /tmp/ppz-fstab
	 for MNTPT in / ${MNTPTS[@]}; do
		  local DEV=
		  until [ -b "${DEV}" ]; do
				[ "$DEV" ] && partprobe 2>&1 | grep -iv /dev/sr0
				usetvar DEV "CHOOSE A PARTITION FOR $MNTPT (^c to partprobe): " /dev/
				DEV=$(readlink -e ${DEV})
		  done
		  askyn "Format $DEV ext4?" && {
				askyn "Check for bad blocks?" && BBOPT=cc || BBOPT=q
				mke2fs -t ext4 -${BBOPT}E lazy_itable_init=1,discard \
					 -O dir_index,extent,flex_bg,has_journal,uninit_bg,large_file,resize_inode,sparse_super ${DEV} \
					 || askyn "mkfs failed. Continue?"
			  #tune2fs 
		  }
		  mkdir -p ${TARGET}${MNTPT}
		  mount ${DEV} ${TARGET}${MNTPT}
		  cat >> /tmp/ppz-fstab <<-EOF
				UUID="$(blkid -s UUID -o value ${DEV})" ${MNTPT}	ext4 defaults,noatime,nodiratime,barrier=1,commit=30,ro 0 1
				EOF
		  enhash targmnt${MNTPT//\/} ${DEV}
	 done
	 mkdir -pm 755 ${TARGET}/{dev,proc,sys,var/{cache/pacman/pkg,lib/pacman,log}}
	 for SPECIAL_FS in proc sys dev; do
		  grep -iq ${TARGET}/${SPECIAL_FS} /etc/mtab || {
				case $SPECIAL_FS in
					 proc)	mount -t proc	none	${TARGET}/proc;;
					 sys)	mount -t sysfs	none	${TARGET}/sys;;
					 dev)	mount -o bind	/dev	${TARGET}/dev;;
				esac
		  }
	 done
	 pacman --config /etc/pacman.conf.bootstrap \
		  --root ${TARGET} \
		  --cachedir ${TARGET}/var/cache/pacman/pkg \
		  --dbpath ${TARGET}/var/lib/pacman \
		  --logfile ${TARGET}/var/log/pacman.log \
		  --noprogressbar --noconfirm -Syq initscripts
	 set +o noclobber && {
		  cp -f /etc/rc.conf.ppz ${TARGET}/etc/rc.conf
		  usetvar    HOSTNAME "Choose a new hostname! Take your time ;) " new_arch_machine_$(date +%Y_%m_%d)
		  usetvar    XRGUSER "Choose name of X user to boot into (blank for none): " '' ''
		  usetvar    ENCUSER "Choose name of encrypted user (blank for none): " '' ''
		  sed -i \
				-e s/%SET_HOSTNAME%/${HOSTNAME}/ig \
				-e s/%SET_XRGUSER%/${XRGUSER}/ig \
				-e s/%SET_ENCUSER%/${ENCUSER}/ig ${TARGET}/etc/rc.conf
		  chroot ${TARGET} /usr/sbin/useradd -lMNd /etc/skel.ppz  -u 54344 ${XRGUSER}
		  chroot ${TARGET} /usr/sbin/useradd -lMNd /media/encuser -u 54345 -s /usr/bin/womb ${ENCUSER}
		  cat >  ${TARGET}/etc/fstab <<-EOF
				devpts /dev/pts devpts defaults 0 0
				UUID=4C93-65D0  /media/oxygen   vfat    defaults,user,noatime,nodiratime,fmask=177,dmask=077,check=s 0 0
				EOF
		  cat >> ${TARGET}/etc/fstab < /tmp/ppz-fstab
		  rm -f /tmp/ppz-fstab
#		  cp -f ${TARGET}/etc/localtime /tmp/target-localtime-examine
#		  echo_red "Look at /tmp/target-localtime-examine to see what it was"
		  cp -i {,${TARGET}}/etc/localtime
		  set -o noclobber
	 }
	 pkgs_groups=(desktop wireless laptop neverneed)
	 pkgs_desktop=(xorg-server seamonkey fvwm wmctrl xclip mplayer urxvt-url-select gimp fbpanel) #squeaker
	 pkgs_wireless=(wpa_supplicant) #wpa_actiond ifplugd
	 pkgs_laptop=(pcmciautils dhcpcd)
	 pkgs_neverneed=(licenses logrotate lvm2 nano ppp reiserfsprogs xfsprogs)
	 pkgs_go=($(comm -23 \
		  <(pacman --config /etc/pacman.conf.bootstrap -Sgq base | sort -u) \
		  <(eval eval list_sorted '\$\{pkgs_'$(commalist ${pkgs_groups[@]})'[@]\}') \
		  ))
	 local A=; for A in ${pkgs_groups[@]}; do
		  eval askyn 'Install $A things? \(${pkgs_'$A'[@]}\)' && eval 'pkgs_go+=(${pkgs_'$A'[@]})'
	 done
	 pkgs_go+=(btrfs-progs-unstable proterozoic) # grub2-bios
	 usetvar others "Type in any other packages you want to add: " 'nvidia' ''
	 pkgs_go+=(${others//,/ })
	 pacman --config /etc/pacman.conf.bootstrap \
		  --root ${TARGET} \
		  --cachedir ${TARGET}/var/cache/pacman/pkg \
		  --dbpath ${TARGET}/var/lib/pacman \
		  --logfile ${TARGET}/var/log/pacman.log \
		  --noprogressbar --noconfirm --needed -Sq ${pkgs_go[@]}
	 cp -f ${TARGET}/etc/pacman.conf{.bootstrap,}
	 askyn "Use present net config as static on target?" && {
		  cp -f {,${TARGET}}/etc/resolv.conf
		  ifconfig | awk <(cat <<-EOF
				/^lo/ {exit}
				$1 ~ /^inet$/ {
					sub(/addr:/,"address=",$2)
					sub(/Mask:/,"netmask=",$4)
					print $2 "\n" $4
				}
				EOF
		  ) >> ${TARGET}/etc/rc.conf
		  ip route show | awk '/^default via/ {print "gateway=" $3 "\ninterface=" $5}' >> ${TARGET}/etc/rc.conf
	 }
	 askyn "Set root password now?" && {
		  while true; do
				chroot ${TARGET} passwd root && break
		  done
	 }
	 grep -iqE '^HOOKS="[^"]*ppz_tmp[^"]*"' ${TARGET}/etc/mkinitcpio.conf || {
		  askyn "Add ppz_tmp to HOOKS?" \
				&& sed -i 's/^\(HOOKS="[^"]*\)"/\1 ppz_tmp"/ig' ${TARGET}/etc/mkinitcpio.conf
	 }
	 grex ${TARGET}/etc/mkinitcpio.conf
	 askyn "Above is ${TARGET}/etc/mkinitcpio.conf. You have a chance to edit
in another tty, if you wish. YES here to rebuild." && {
		  chroot ${TARGET} /sbin/mkinitcpio -p kernel26
	 }
	 askyn "Install grub? (un/freeze XFS if you have to...)" && {
		  cp -a ${TARGET}/usr/lib/grub/i386-pc/* ${TARGET}/boot/grub/
		  DMAPF=/tmp/grub-device-map-ppz
		  echo "quit" | ${TARGET}/sbin/grub --no-floppy --device-map ${DMAPF}
		  local BOOT_RAWDEVICE=$(unhash targmntboot | sed 's/[0-9]*$//')
		  local BOOT_PARTNUMBR=$(unhash targmntboot | sed 's/^[^0-9]*//')
		  let BOOT_PARTNUMBR-- || echo "partition number was zero -- wtf??"
		  local BIOS_HDNUM=$(awk '$2 == "'$BOOT_RAWDEVICE'" {gsub(/[()]/,"",$1);print $1}' ${DMAPF})
		  echo "You need to finish grub. Make /boot/grub/menu.lst & do:"
		  echo "  ${TARGET}/sbin/grub --no-floppy --batch "'<<-EOF blah blah blah... '
		  echo "    targmntboot was: "$(unhash targmntboot)
		  echo "    device ($BIOS_HDNUM) $BOOT_RAWDEVICE"
		  echo "    geometry ($BIOS_HDNUM)"
		  echo "    root ($BIOS_HDNUM,$BOOT_PARTNUMBR)"
		  echo "    setup ($BIOS_HDNUM)"
#		  rm -f ${DMAPF}
	 }
	 echo "Networking was not set up. You might want to edit these files:"
	 echo "		/etc/rc.conf"
	 echo "		/etc/resolv.conf"
	 echo "		/etc/profile.d/proxy.sh"
	 until askyn "ready to quit? (stuff will be unmounted)"; do
		  ll ${TARGET}/
	 done
	 unmount_all
	 poptrap
}
