#!/usr/bin/bash
# mpv but a little easier

. /usr/share/ppz/bash.functions
. /usr/share/ppz/bash.functions.xorg

userscript=$HOME/.config/bin/pre-mm.sh

nice=false debug=no
args=() files=() x=700 y=400 holdss=''
for arg; do
    if [ -a "$arg" ]; then
        if [[ "$arg" =~ .(srt|sub)$ ]]; then
            args+=("--sub-file=$arg")
        else
            files+=("$arg")
        fi
        continue
    fi
    case "$arg" in
        --nice) nice=true;;
        --debug) debug=warn;;
        *)
            is_ssh_host "$arg" && {
                as=mm
                for a in "$@"; do
                    [ "$a" = "$arg" ] || as="$as $(printf %q "$(printf %q "$a")")"
                done
                exec urxvtb -pe -tabbedex -geometry 80x6+720+694 -e bash -c \
                    "exec ssh -t $arg exec $as"
            }
            args+=("$arg")
    esac
done

for file in "${files[@]}"; do
    [[ "$file" =~ \.(avi|mkv|mp4) ]] && holdss=y
done

$nice && do_unto_others

set_xtitle "[mm] $*"

if [ -O "$userscript" ] && [ -x "$userscript" ]; then
    holdss="$holdss" "$userscript"
fi

[ "$holdss" ] && {
    holdss &
    trap "kill -SIGHUP $!" EXIT HUP QUIT INT TERM ABRT
    args+=(--stop-screensaver)
}

ionice -c 2 -n 0 nice -n 0 mpv --geometry=${x}x${y} -fs --ao=alsa \
    --alang=en --slang=en \
    --msg-level=all=${debug}:statusline=status:cache=info:network=info \
    --cache-initial=1024 --cache=256000 --no-input-default-bindings \
    --input-conf=/usr/share/ppz/mplayer.input.conf \
    --term-status-msg='${time-pos} / ${duration} (${percent-pos}%) ${filename}' \
    --no-osc --script-opts=osc-visibility=always,osc-timems=no,osc-layout=topslim \
    --cursor-autohide=always \
    --hr-seek=yes "${args[@]}" "${files[@]}"

echo
