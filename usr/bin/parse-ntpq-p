#!/bin/gawk -f
#
# Parse the ntp peers list, like this:
# ntpq -p | parse-ntpq-p [deviation]
#
# if any numbers are too big, throws error

BEGIN {
	 RV=0

	 # how much we allow (default)
	 deviation=0.005 # e.g. "3", ".1", etc

	 # any numeric arguments become deviation!
	 for (i = 1; i < ARGC; i++)
		  if (ARGV[i] ~ /^[0-9\.]+$/) {
				deviation=ARGV[i]
				delete ARGV[i]
		  }
}

/^=+$/ {
	 next
}

$1 ~ /^remote$/ {
	 next
}

function red(str) {
	 return "\033[1;31m" str "\033[22;39m"
}

function ifzero(num) {
	 if (num <= deviation) return;
	 print red("OFF: ") $0
	 RV=1
	 next
}

{
	 ifzero($8)
	 ifzero($9)
	 ifzero($10)
}

END {
	 exit RV
}
