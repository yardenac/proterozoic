#!/usr/bin/python2
#
# This script checks the system time against an ntp pool.
# If the network and system time are both peachy, then it 
# exits promptly and quietly. If something needs fixing, 
# it will speak up and possibly exit with an error.
#
import struct, sys, time, socket, math

client = socket.socket( socket.AF_INET, socket.SOCK_DGRAM )
data = '\x1b' + 47 * '\0'
beforesend = time.time()
client.settimeout(4)
client.sendto( data, ( "0.us.pool.ntp.org", 123 )) or sys.exit(4)
data, address = client.recvfrom( 1024 )
aftersend = time.time()
if data:
    interval = ((aftersend - beforesend) / 2)
    us = aftersend - interval
    them = struct.unpack( '!12I', data )[10] - 2208988800L - interval
    sigsecs = round(abs(them - us),0)
    prepos = " " + ("fast" if (us > them) else "slow")
    if (sigsecs > 1):
        prepos = "s" + prepos
    if (sigsecs > 3):
        print "Clock is %d second%s!" % (sigsecs,prepos)
    sys.exit(sigsecs > 5)
sys.exit(3)
