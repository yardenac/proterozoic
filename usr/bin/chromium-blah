#!/usr/bin/bash

. /usr/share/ppz/bash.functions
tor=true
proxy=--proxy-server=localhost:8118
resolv='--host-resolver-rules=MAP * 0.0.0.0'
configdir=/etc/skel.ppz/.config/chromium
fjargs=() urls=() cleanup=y uniqtok=$(uniq_token)
uniqdir="$HOME/.config/chromium.$uniqtok"
profile=--profile=/etc/firejail/chromium-ppz.profile
for arg; do
    [[ "$arg" =~ ^[0-9]+$ ]] && {
        proxy=--proxy-server=socks5://localhost:"$arg"
        tor=false
        continue
    }
    case "$arg" in
        tor)     :;;
        noproxy) proxy=''; resolv=''; tor=false;;
        mine)    configdir="${HOME}/.config/chromium";;
        --devs)  fjargs+=--ignore=nou2f;;
        --keepin=*)   cleanup=''; uniqdir="$HOME/.config/chromium.${arg##*=}";;
        *)       urls+=("$arg");;
    esac
done

(( "${#urls[@]}" )) || {
    if $tor; then
        urls=('http://3g2upl4pq6kufc4m.onion/?kp=-1&kf=w&kk=-1&k1=-1&ko=s')
    else
        urls=('chrome://version')
    fi
}

if [ ! -d "$uniqdir" ]; then
    cp -r "$configdir" "$uniqdir"
fi

if [[ "$cleanup" ]] && ! $tor; then
    sedexp='s%http://3g2upl4pq6kufc4m.onion/%https://duckduckgo.com/%ig'
    sed -i "$sedexp" "${uniqdir}/Default/Preferences"
    rm -f "${uniqdir}/Default/Web Data"
    sed "$sedexp" /usr/share/ppz/chromium.web.data.sql \
        | sqlite3 "${uniqdir}/Default/Web Data"
fi

ionice -c 2 -n 0 nice -n 10 \
   firejail $profile "${fjargs[@]}" chromium --incognito \
      --load-extension=/usr/share/newsblurbackgroundtab-git,/usr/share/https-everywhere-chrome-git,/usr/share/stylus-git,/usr/share/chromium-ublock-origin-git,/usr/share/chromium-pdfjs-git/chromium \
      --ssl-version-min=tls1 \
      --user-data-dir="$uniqdir" "$proxy" "$resolv" "${urls[@]}"

if [[ "$cleanup" ]]; then
    rm -rf "$uniqdir" "$HOME/.cache/chromium.$uniqtok"
fi
