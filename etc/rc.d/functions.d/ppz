#!/bin/bash
. /etc/bash.functions
have_mount_point() {
	 [ -a "$1" ] || mkdir "$1"
	 [ -L "$1" ] && {
		  rm -f "$1"
		  mkdir "$1"
	 }
	 [ -d "$1" ] && {
		  is_empty_dir "$1" || {
				rsync -aAXD "$1/" /tmp
				echo "EVERYTHING'S BEEN COPIED, DON'T WORRY..."
				rm -ri "$1"
				mkdir "$1"
		  }
	 }
	 [ -d "$1" ] || {
		  echo "$1 is not a link or a dir... weird"
		  return 1
	 }
}
tmp_bind() {
	 for P in "$@"; do
		  have_mount_point "$P" && mount --bind /tmp "$P"
	 done
}
tmp_to_shm()    { tmp_bind /dev/shm /media/inmem; }
tmp_to_vartmp() { tmp_bind /var/tmp; }
do_edie_var() {
    mkdir /tmp/.aufs.var
    if [ $( ls -A1d /var/* 2>/dev/null | wc -l ) -gt 0 ]; then
		  VARHOLD=/.var.$( date +%s )
		  mv /var $VARHOLD
		  mkdir /var
		  mount -t aufs -o br:/tmp/.aufs.var=rw:/.var.old=ro,xino=/tmp/.aufs.xino,noauto,noatime,nodiratime,udba=none none /var
		  cp -av $VARHOLD/* /var/
		  rm -rv $VARHOLD
    else
		  [ -a /var ] || mkdir /var
		  mount -t aufs -o br:/tmp/.aufs.var=rw:/.var.old=ro,xino=/tmp/.aufs.xino,noauto,noatime,nodiratime,udba=none none /var
    fi
	 tmp_to_vartmp
}
custom_mounting_everyone() {
	 case $HOSTNAME in
		  ediacra) do_edie_var;;
	 esac
	 /usr/bin/integrity.ppz
}
add_hook sysinit_udevlaunched tmp_to_shm
case $HOSTNAME in
	 ediacra)	:;;
	 *)			add_hook sysinit_udevlaunched tmp_to_vartmp;;
esac
add_hook sysinit_premount custom_mounting_everyone
