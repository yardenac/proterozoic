#!/bin/bash
. /usr/share/ppz/bash.functions
have_mount_point() {
	 [ -a "$1" ] || mkdir "$1"
	 [ -L "$1" ] && {
		  rm -f "$1"
		  mkdir "$1"
	 }
	 [ -d "$1" ] && {
		  is_empty_dir "$1" || {
				rsync -aAXD "$1/" /tmp
				echo "EVERYTHING'S BEEN COPIED, DON'T WORRY..."
				rm -ri "$1"
				mkdir "$1"
		  }
	 }
	 [ -d "$1" ] || {
		  echo "$1 is not a link or a dir... weird"
		  return 1
	 }
}
tmp_bind() {
	 for P in "$@"; do
		  have_mount_point "$P" && mount --bind /tmp "$P"
	 done
}
tmp_to_shm()    { tmp_bind /dev/shm /media/inmem; }
tmp_to_vartmp() { tmp_bind /var/tmp; }
custom_mounting_everyone() {
	 /usr/bin/integrity.ppz
}
add_hook sysinit_udevlaunched tmp_to_shm
add_hook sysinit_udevlaunched tmp_to_vartmp
add_hook sysinit_premount custom_mounting_everyone
custom_iptables_rules() {
	 echo DOING IPTABLES RULES
	 for PORT in ${OPEN_PORTS[@]}; do
		  echo OPENING PORT $PORT
		  local PROTOCOL=tcp
		  [[ ${PORT} =~ : ]] && PROTOCOL=${PORT%%:*}
		  iptables -A open -p ${PROTOCOL} -m ${PROTOCOL} --dport ${PORT##*:} -j ACCEPT
	 done
}
add_hook multi_end custom_iptables_rules
