#!/bin/bash
. /usr/share/ppz/bash.functions
set_hacks() {
	 set +o noclobber
	 echo 2000 > /sys/module/block/parameters/events_dfl_poll_msecs
	 set -o noclobber
}
resolv_override() {
	 [ -f /etc/resolv.conf.override ] \
		  && rm -f /etc/resolv.conf \
		  && cp -f /etc/resolv.conf{.override,}
}
stop_torrents() {
	 local t=100 tm=/usr/bin/transmission-remote
	 if [ -x $tm ] && pgrep -f transmission-daemon &>/dev/null; then
		  echo_blue_n "Shutting down torrents..."
		  su - eu -c "$tm --exit" &>/dev/null || { echo_red "failed!"; return 1; }
		  while pgrep -f transmission-daemon &>/dev/null; do
				let t-- || { echo_red "timed out!"; return 1; }
				echo_blue_n .
				sleep 3
		  done
		  echo_blue "done!"
	 fi
}
print_welcome() {
	 : # echo_yellow BOOTING ARCH LINUX / PROTEROZOIC
}
add_hook sysinit_udevsettled	set_hacks
add_hook sysinit_premount		/usr/bin/integrity.ppz
add_hook multi_start				resolv_override
add_hook shutdown_start			stop_torrents
