#!/bin/bash
# <UDF name="ss_hostname" label="hostname" />
# <UDF name="ss_encuser"  label="encrypted user" />
echo bootstrapping for the 2010.05 linode image...

echo "stackscript actually ran!" > /etc/telltale-file

gshmd=$(md5sum /etc/gshadow)
case "$gshmd" in
	 3e5a0173e8b706c4416c6ec43e89c866)	echo "linode image COMES with the altered gshadow (they added dbus)";;
	 eb238381144e9e6b2adc0d11f528e431)	echo "they just added the one dbus line at some point... but when?";;
	 *)	echo "for some reason gshadow md5sum is: $gshmd"
			echo "Contents of gshadow:"
			cat /etc/gshadow
			echo "End gshadow"
esac

this_pacman() {
	 pacman --config /etc/pacman.conf --noprogressbar --noconfirm "$@"
}
GITURL=https://raw.github.com/twomen/proterozoic/master

mv -f /etc/rc.conf{,.original}
mv -f /etc/sudoers{,.original}
mv -f /etc/pacman.conf{,.original}
wget $GITURL/usr/share/ppz/default-rc.conf		-qO	/etc/rc.conf
wget $GITURL/etc/pacman.d/mirrorlist.otown		-qO	/etc/pacman.d/mirrorlist.otown.tmp
wget $GITURL/usr/share/ppz/default-pacman.conf	-qO	/etc/pacman.conf
sed -i s/otown/otown.tmp/ig									/etc/pacman.conf
sed -i \
	 -e s/%SET_HOSTNAME%/${SS_HOSTNAME}/ig \
	 -e s/%SET_ENCUSER%/${SS_ENCUSER}/ig \
	 -e s/=UTC/=xen/ig \
	 -e 's/^SSH_USERS.*$/SSH_USERS=(root)/ig'				/etc/rc.conf

# not to dl sync files, use after troubleshooting
#	 -e 's`^[\t ]*/.*___[a-f0-9]*___.*\.\(png\|bin\.gz\)$``ig' \

cat > /etc/locale.gen <<-EOF
		en_US.UTF-8 UTF-8
		en_US ISO-8859-1
		es_US.UTF-8 UTF-8
		es_US ISO-8859-1
		he_IL.UTF-8 UTF-8
		he_IL ISO-8859-8
		iw_IL.UTF-8 UTF-8
		iw_IL ISO-8859-8
		de_DE.UTF-8 UTF-8
		de_DE ISO-8859-1
		EOF
locale-gen

this_pacman -Sqy pacman
pacman-db-upgrade
this_pacman -Sqyu
mv -f /etc/bash.bashrc{.pacnew,}
this_pacman -Sq mkinitcpio
sed -i 's/^\(HOOKS="[^"]*\)"/\1 ppz_tmp"/ig' /etc/mkinitcpio.conf
mv -f /etc/hosts{.pacnew,}
this_pacman -Sq proterozoic
cat > /etc/mkinitcpio.conf <<-EOF
	HOOKS="base udev autodetect ppz_tmp"
EOF
this_pacman -Sq linux-linode

rm -f \
	 /etc/pacman.d/mirrorlist.otown.tmp \
	 /etc/{locale.gen,securetty,hosts,inittab,pacman.d/mirrorlist}.pacnew

# why do the remote sync files not happen together
# how to get proper "kernel name" in install file?

add_hook() { :; }
. /etc/rc.conf
. /etc/rc.d/functions.d/ppz
. /usr/share/ppz/bash.functions.install
custom_iptables_rules
static_networking_from_runtime /
useradd -lMNd /media/encuser -u 54345 -s /usr/bin/womb ${SS_ENCUSER}
